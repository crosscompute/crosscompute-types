function get_geotable_adjective(key){var adjective_string="streets|light|dark|satellite|streets-satellite|wheatpaste|streets-basic|comic|outdoors|run-bike-hike|pencil|pirates|emerald|high-contrast".replace(/-/g,"[-_]");try{return RegExp("("+adjective_string+")_geotable").exec(key)[1].replace(/_/g,"-")}catch(e){return"streets"}}function draw_map(k,v){for(var map_id=k+"-map",table_id=k+"-table",map=L.mapbox.map(map_id,"mapbox."+get_geotable_adjective(k)),features=[],feature_packs=v[0],properties=v[1],i=0;i<feature_packs.length;i++){var feature,p=feature_packs[i],geometry_type_id=p[0],geometry_coordinates=p[1],d=$.extend({color:"black",weight:2,opacity:.7,fillColor:"yellow",fillOpacity:.5},properties,p[2]);switch(geometry_type_id){case 1:d.radius_in_meters?feature=L.circle(geometry_coordinates,d.radius_in_meters,d):(feature=L.circleMarker(geometry_coordinates,d),d.radius_in_pixels&&feature.setRadius(d.radius_in_pixels));break;case 2:feature=L.polyline(geometry_coordinates,d);break;case 3:feature=L.multiPolyline(geometry_coordinates,d)}feature.geotable={table_id:table_id,tbody_id:table_id.replace("-table","-row")+i},feature.on("click",function(){var a=this.geotable,b=$("#"+a.tbody_id).show();$("#"+a.table_id+" tbody").not(b).hide(),$("#"+a.table_id).show()}),features.push(feature)}features.length&&map.fitBounds(L.featureGroup(features).addTo(map).getBounds()).on("click",function(){$("#"+table_id).hide()})}$(".geotable-upload").on("uploaded.ir.upload",function(e,d){var argument_name=$(this).parent().data("name"),target_id=argument_name,$target=$("#"+target_id);$.post("/c/geotable/import_geotable",{upload_id:d.upload_id,argument_name:argument_name}).fail(function(x){$target.find(".geotable-map").html(x.responseJSON[argument_name])}).success(function(x){$("[name="+target_id+"]").val(d.upload_id),$target.html(x);var script_text=$target.find("script").text().replace(/'/g,'"'),script_json="[["+/(\[.*\]);/.exec(script_text)[1];draw_map(argument_name,$.parseJSON(script_json))})});
