{% macro head_style_loaded() %}
<link rel="stylesheet" href="//cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css">
{% endmacro %}

{% macro head_style_inline() %}
.geotable-map {height: 300px}
{% endmacro %}

{% macro body_script_loaded() %}
<script src="//cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
{% endmacro %}

{% macro body_script_inline() %}
{% endmacro %}

{% macro render_query(key) %}
{% endmacro %}

{% macro render_value(key, value_by_key) %}
<h3>{{ key }}</h3>
<div id="{{ key }}_" class="geotable-map"></div>
<script>
setTimeout(function() {
  var map = L.map('{{ key }}_');

  L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6IjZjNmRjNzk3ZmE2MTcwOTEwMGY0MzU3YjUzOWFmNWZhIn0.Y8bhBaUMqFiPrDRW9hieoQ', {
    maxZoom: 18,
    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery &copy; <a href="http://mapbox.com">Mapbox</a>',
    id: 'mapbox.streets'
  }).addTo(map);

  function getColor(x) {
    return x < 11 ? '#fff7ec': x < 22 ? '#fee8c8': x < 33 ? '#fdd49e': x < 44 ? '#fdbb84': x < 55 ? '#fc8d59': x < 66 ? '#ef6548': x < 77 ? '#d7301f': x < 88 ? '#b30000': '#7f0000';
  }

  var markers = [];
  {% for (longitude, latitude), d in value_by_key.items() %}
    {% set table = d['table'] %}
    markers.push(L.circle([{{ latitude }}, {{ longitude }}], {{ 25 + d['count'] * 100 }}, {
      color: 'black',
      opacity: 1,
      fillColor: getColor({{ 100 * d['weight'] }}),
      fillOpacity: 0.7
    }).on('click', function() {
      $('#{{ key }}__').html('<table class="table"><tr>{% for column in table.columns %}<th>{{ column }}</th>{% endfor %}</tr>{% for index, row in table.fillna(\'\').iterrows() %}<tr>{% for column in row %}<td>{{ column }}</td>{% endfor %}</tr>{% endfor %}</table>');
    }));
  {% endfor %}
  var group = L.featureGroup(markers).addTo(map);
  map.fitBounds(group.getBounds());
  map.on('click', function() {
    $('#{{ key }}__').html('');
  });
}, 1500);
</script>
<div id="{{ key }}__"></div>
{% endmacro %}
