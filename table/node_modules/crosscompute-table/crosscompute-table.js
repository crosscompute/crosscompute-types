function make_editable_table($table) {
  $table.editableTableWidget({
    'editor': $('<input class="table-editable-input">')
  });
}

function get_csv($table) {
  var rows = [];
  $.each($table.find('tr'), function(i, row) {
    var columns = [];
    $.each($(row).children('th,td'), function(i, column) {
      columns.push('"' + $(column).text().replace(/"/g, '""') + '"');
    });
    rows.push(columns.join(','));
  });
  return rows.join('\n');
}

$('.table-upload').on('uploaded.ir.upload', function(e, d) {
  var argument_name = $(this).parent().data('name'),
      target_id = argument_name, $target = $('#' + target_id);

  $.post('/c/table/import_table', {
    upload_id: d.upload_id,
    argument_name: argument_name
  }).fail(function(x) {
    $target.find('.scrollable').html(x.responseJSON[argument_name]);
  }).success(function(x) {
    $target.html(x);
    make_editable_table($target.find('.table-editable'));
  });
});

$('#arguments').on('updated.cc', function() {
  $('.table-editable').each(function() {
    var $table = $(this), table_id = $table.attr('id'), csv = get_csv($table);
    $('[name=' + table_id + '_csv]').val(csv);
  });
});

make_editable_table($('.table-editable'));
