function make_editable_table($table) {
  $table.editableTableWidget({
    'editor': $('<input class="editable-table-input">')
  });
}

function get_csv($table) {
  var rows = [];
  $.each($table.find('tr'), function(i, row) {
    var columns = [];
    $.each($(row).children('th,td'), function(i, column) {
      columns.push('"' + $(column).text().replace(/"/g, '""') + '"');
    });
    rows.push(columns.join(','));
  });
  return rows.join('\n');
}

$('.table-upload').on('uploaded.ir.upload', function(e, d) {
  var upload_id = d.id, field_id = $(this).parent().data('name');
  var target_id = field_id + '-upload', $target = $('#' + target_id);

  $.post('/c/table/import_table', {'id': upload_id, 'name': field_id})
    .fail(function(d) {
      $target.find('.scrollable').html(d.responseJSON[field_id]);
    })
    .success(function(d) {
      $target.html(d);
      make_editable_table($target.find('.editable-table'));
    });
});

$('#tool-form').submit(function() {
  $('.editable-table').each(function() {
    var $table = $(this), table_id = $table.attr('id'), csv = get_csv($table);
    $('[name=' + table_id + '-csv]').val(csv);
  });
});

if (!g.invisibleroads_users || g.invisibleroads_users.user_id) {
  make_editable_table($('.editable-table'));
}
