function get_csv($table) {
  var rows = [];
  $.each($table.find('tr'), function(i, row) {
    var columns = [];
    $.each($(row).children('th,td'), function(i, column) {
      columns.push('"' + $(column).text().replace(/"/g, '""') + '"');
    });
    rows.push(columns.join(','));
  });
  return rows.join('\n');
}

$('.table-upload').on('uploaded.ir', function(e, d) {
  var $o = $(this), $feedback = $o.next('.feedback');
  $feedback.text('Loading... Large datasets can take a few minutes');

  var argument_name = $(this).data('name'),
      target_id = argument_name, $target = $('#' + target_id);

  $.post(CC.table.import_url, {
    upload_id: d.upload_id,
    argument_name: argument_name
  }).fail(function(x) {
    $target.find('.scrollable').html(x.responseJSON[argument_name]);
  }).success(function(x) {
    $target.html(x);
    $('[name=' + target_id + ']').val(d.upload_id);
  }).always(function() {
    $feedback.text('');
  });
});

$('#arguments').on('updated.cc', function() {
  $('table.editable').each(function() {
    var $o = $(this),
        key = $o.parent('div').parent('div').attr('id'),
        csv = get_csv($o);
    $('[name=' + key + '_csv]').val(csv);
  });
});
