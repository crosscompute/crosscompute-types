function make_editable_table($table){$table.editableTableWidget({editor:$('<input class="editable-table-input">')})}function get_csv($table){var rows=[];return $.each($table.find("tr"),function(i,row){var columns=[];$.each($(row).children("th,td"),function(i,column){columns.push('"'+$(column).text().replace(/"/g,'""')+'"')}),rows.push(columns.join(","))}),rows.join("\n")}$.fn.editableTableWidget=function(options){"use strict";return $(this).each(function(){var active,buildDefaultOptions=function(){var opts=$.extend({},$.fn.editableTableWidget.defaultOptions);return opts.editor=opts.editor.clone(),opts},activeOptions=$.extend(buildDefaultOptions(),options),ARROW_LEFT=37,ARROW_UP=38,ARROW_RIGHT=39,ARROW_DOWN=40,ENTER=13,ESC=27,TAB=9,element=$(this),editor=activeOptions.editor.css("position","absolute").hide().appendTo(element.parent()),showEditor=function(select){active=element.find("td:focus"),active.length&&(editor.val(active.text()).removeClass("error").show().offset(active.offset()).css(active.css(activeOptions.cloneProperties)).width(active.width()).height(active.height()).focus(),select&&editor.select())},setActiveText=function(){var originalContent,text=editor.val(),evt=$.Event("change");return!(active.text()!==text&&!editor.hasClass("error"))||(originalContent=active.html(),active.text(text).trigger(evt,text),void(evt.result===!1&&active.html(originalContent)))},movement=function(element,keycode){return keycode===ARROW_RIGHT?element.next("td"):keycode===ARROW_LEFT?element.prev("td"):keycode===ARROW_UP?element.parent().prev().children().eq(element.index()):keycode===ARROW_DOWN?element.parent().next().children().eq(element.index()):[]};editor.blur(function(){setActiveText(),editor.hide()}).keydown(function(e){if(e.which===ENTER)setActiveText(),editor.hide(),active.focus(),e.preventDefault(),e.stopPropagation();else if(e.which===ESC)editor.val(active.text()),e.preventDefault(),e.stopPropagation(),editor.hide(),active.focus();else if(e.which===TAB)active.focus();else if(this.selectionEnd-this.selectionStart===this.value.length){var possibleMove=movement(active,e.which);possibleMove.length>0&&(possibleMove.focus(),e.preventDefault(),e.stopPropagation())}}).on("input paste",function(){var evt=$.Event("validate");active.trigger(evt,editor.val()),evt.result===!1?editor.addClass("error"):editor.removeClass("error")}),element.on("click keypress dblclick",showEditor).css("cursor","pointer").keydown(function(e){var prevent=!0,possibleMove=movement($(e.target),e.which);possibleMove.length>0?possibleMove.focus():e.which===ENTER?showEditor(!1):17===e.which||91===e.which||93===e.which?(showEditor(!0),prevent=!1):prevent=!1,prevent&&(e.stopPropagation(),e.preventDefault())}),element.find("td").prop("tabindex",1),$(window).on("resize",function(){editor.is(":visible")&&editor.offset(active.offset()).width(active.width()).height(active.height())})})},$.fn.editableTableWidget.defaultOptions={cloneProperties:["padding","padding-top","padding-bottom","padding-left","padding-right","text-align","font","font-size","font-family","font-weight","border","border-top","border-bottom","border-left","border-right"],editor:$("<input>")},$(".table-upload").on("uploaded.ir.upload",function(e,d){var argument_name=$(this).parent().data("name"),target_id=argument_name,$target=$("#"+target_id);$.post("/c/table/import_table",{upload_id:d.upload_id,argument_name:argument_name}).fail(function(x){$target.find(".scrollable").html(x.responseJSON[argument_name])}).success(function(x){$target.html(x),make_editable_table($target.find(".editable-table"))})}),$("#arguments").on("updated.cc",function(){$(".editable-table").each(function(){var $table=$(this),table_id=$table.attr("id"),csv=get_csv($table);$("[name="+table_id+"_csv]").val(csv)})}),make_editable_table($(".editable-table"));
